import { PrismaClient } from "@prisma/client";
import bcrypt from "bcryptjs";
import QRCode from "qrcode";

const prisma = new PrismaClient();

async function generateQRCodeDataURL(data) {
  try {
    const qrCodeDataURL = await QRCode.toDataURL(data, {
      errorCorrectionLevel: "M",
      type: "image/png",
      quality: 0.92,
      margin: 1,
      color: {
        dark: "#000000",
        light: "#FFFFFF",
      },
    });
    return qrCodeDataURL;
  } catch (error) {
    console.error("Erreur lors de la g√©n√©ration du QR code:", error);
    return null;
  }
}

async function main() {
  console.log("üå± D√©marrage du seeding avec employ√©s et QR codes...");

  try {
    // Supprimer les donn√©es existantes dans l'ordre correct
    await prisma.attendance.deleteMany({});
    await prisma.workSchedule.deleteMany({});
    await prisma.payslip.deleteMany({});
    await prisma.payRun.deleteMany({});
    await prisma.employee.deleteMany({});
    await prisma.user.deleteMany({});
    await prisma.company.deleteMany({});
    console.log("üóëÔ∏è  Donn√©es existantes supprim√©es");

    // Cr√©er des entreprises de test
    console.log("üè¢ Cr√©ation des entreprises...");
    const companies = await Promise.all([
      prisma.company.create({
        data: {
          name: "Tech Solutions SARL",
          email: "contact@techsolutions.com",
          phone: "+221 33 812 00 01",
          address: "Dakar, Almadies",
          isActive: true,
        },
      }),
      prisma.company.create({
        data: {
          name: "Digital Marketing Pro",
          email: "info@digitalmarketing.sn",
          phone: "+221 33 812 00 00",
          address: "Dakar, Plateau",
          isActive: true,
        },
      }),
    ]);

    console.log(`‚úÖ ${companies.length} entreprises cr√©√©es`);

    // Cr√©er le Super Admin (sans entreprise)
    const superAdmin = await prisma.user.create({
      data: {
        firstName: "Super",
        lastName: "Administrator",
        email: "superadmin@gestion-salaires.com",
        password: await bcrypt.hash("superadmin123", 10),
        role: "SUPER_ADMIN",
        isActive: true,
      },
    });

    console.log("‚úÖ Super Admin cr√©√©");

    // Cr√©er des admins pour chaque entreprise
    // Cr√©er d'abord les employ√©s admin et caissier
    console.log("üë®‚Äçüíº Cr√©ation des employ√©s admin et caissier...");

    // Employ√©s Admin
    const adminEmployees = await Promise.all([
      prisma.employee.create({
        data: {
          firstName: "Admin",
          lastName: "TechSolutions",
          email: "admin@techsolutions.com",
          employeeCode: "ADM001",
          position: "Administrateur",
          contractType: "FIXED",
          fixedSalary: 1200000,
          hireDate: new Date("2020-01-01"),
          isActive: true,
          companyId: companies[0].id,
          qrCode: await generateQRCodeDataURL("ADM001"),
        },
      }),
      prisma.employee.create({
        data: {
          firstName: "Admin",
          lastName: "DigitalMarketing",
          email: "admin@digitalmarketing.sn",
          employeeCode: "ADM002",
          position: "Administrateur",
          contractType: "FIXED",
          fixedSalary: 1200000,
          hireDate: new Date("2020-01-01"),
          isActive: true,
          companyId: companies[1].id,
          qrCode: await generateQRCodeDataURL("ADM002"),
        },
      }),
    ]);

    // Employ√©s Caissier
    const cashierEmployees = await Promise.all([
      prisma.employee.create({
        data: {
          firstName: "Caissier",
          lastName: "TechSolutions",
          email: "caissier@techsolutions.com",
          employeeCode: "CASH001",
          position: "Caissier",
          contractType: "FIXED",
          fixedSalary: 600000,
          hireDate: new Date("2021-01-01"),
          isActive: true,
          companyId: companies[0].id,
          qrCode: await generateQRCodeDataURL("CASH001"),
        },
      }),
      prisma.employee.create({
        data: {
          firstName: "Caissier",
          lastName: "DigitalMarketing",
          email: "caissier@digitalmarketing.sn",
          employeeCode: "CASH002",
          position: "Caissier",
          contractType: "FIXED",
          fixedSalary: 600000,
          hireDate: new Date("2021-01-01"),
          isActive: true,
          companyId: companies[1].id,
          qrCode: await generateQRCodeDataURL("CASH002"),
        },
      }),
    ]);

    // Cr√©er les comptes utilisateurs pour les admins
    const adminUsers = await Promise.all([
      prisma.user.create({
        data: {
          firstName: adminEmployees[0].firstName,
          lastName: adminEmployees[0].lastName,
          email: adminEmployees[0].email,
          password: await bcrypt.hash("admin123", 10),
          role: "ADMIN",
          isActive: true,
          companyId: companies[0].id,
          employeeId: adminEmployees[0].id,
        },
      }),
      prisma.user.create({
        data: {
          firstName: adminEmployees[1].firstName,
          lastName: adminEmployees[1].lastName,
          email: adminEmployees[1].email,
          password: await bcrypt.hash("admin123", 10),
          role: "ADMIN",
          isActive: true,
          companyId: companies[1].id,
          employeeId: adminEmployees[1].id,
        },
      }),
    ]);

    // Cr√©er les comptes utilisateurs pour les caissiers
    const cashierUsers = await Promise.all([
      prisma.user.create({
        data: {
          firstName: cashierEmployees[0].firstName,
          lastName: cashierEmployees[0].lastName,
          email: cashierEmployees[0].email,
          password: await bcrypt.hash("caissier123", 10),
          role: "CASHIER",
          isActive: true,
          companyId: companies[0].id,
          employeeId: cashierEmployees[0].id,
        },
      }),
      prisma.user.create({
        data: {
          firstName: cashierEmployees[1].firstName,
          lastName: cashierEmployees[1].lastName,
          email: cashierEmployees[1].email,
          password: await bcrypt.hash("caissier123", 10),
          role: "CASHIER",
          isActive: true,
          companyId: companies[1].id,
          employeeId: cashierEmployees[1].id,
        },
      }),
    ]);

    console.log(
      `‚úÖ ${adminEmployees.length} employ√©s admin cr√©√©s avec QR codes et comptes utilisateurs`
    );
    console.log(
      `‚úÖ ${cashierEmployees.length} employ√©s caissier cr√©√©s avec QR codes et comptes utilisateurs`
    );

    // Cr√©er des employ√©s avec QR codes pour Tech Solutions
    console.log("üë• Cr√©ation des employ√©s pour Tech Solutions...");
    const techEmployees = [];

    const techEmployeeData = [
      {
        firstName: "Mamadou",
        lastName: "Kane",
        email: "mamadou.kane@techsolutions.sn",
        employeeCode: "TS001",
        position: "D√©veloppeur Senior",
        contractType: "FIXED",
        fixedSalary: 850000,
        hireDate: new Date("2023-01-15"),
      },
      {
        firstName: "Fatou",
        lastName: "Seck",
        email: "fatou.seck@techsolutions.sn",
        employeeCode: "TS002",
        position: "Chef de Projet",
        contractType: "FIXED",
        fixedSalary: 950000,
        hireDate: new Date("2022-06-10"),
      },
      {
        firstName: "Ousmane",
        lastName: "Sow",
        email: "ousmane.sow@techsolutions.sn",
        employeeCode: "TS003",
        position: "D√©veloppeur Frontend",
        contractType: "FIXED",
        fixedSalary: 650000,
        hireDate: new Date("2023-03-20"),
      },
    ];

    for (const empData of techEmployeeData) {
      // G√©n√©rer le QR code bas√© sur le matricule
      const qrCodeData = await generateQRCodeDataURL(empData.employeeCode);

      const employee = await prisma.employee.create({
        data: {
          firstName: empData.firstName,
          lastName: empData.lastName,
          email: empData.email,
          employeeCode: empData.employeeCode,
          position: empData.position,
          contractType: empData.contractType,
          fixedSalary: empData.fixedSalary,
          hireDate: empData.hireDate,
          isActive: true,
          companyId: companies[0].id,
          qrCode: qrCodeData,
        },
      });

      // Cr√©er un compte utilisateur pour cet employ√©
      const userAccount = await prisma.user.create({
        data: {
          firstName: empData.firstName,
          lastName: empData.lastName,
          email: empData.email,
          password: await bcrypt.hash("employe123", 10), // Mot de passe par d√©faut
          role: "USER",
          isActive: true,
          companyId: companies[0].id,
          employeeId: employee.id,
        },
      });

      techEmployees.push({ employee, user: userAccount });
      console.log(
        `‚úÖ Employ√© ${empData.firstName} ${empData.lastName} cr√©√© avec QR code et compte utilisateur`
      );
    }

    // Cr√©er des employ√©s avec QR codes pour Digital Marketing
    console.log("üë• Cr√©ation des employ√©s pour Digital Marketing...");
    const digitalEmployees = [];

    const digitalEmployeeData = [
      {
        firstName: "Aminata",
        lastName: "Ndiaye",
        email: "aminata.ndiaye@digitalmarketing.sn",
        employeeCode: "DM001",
        position: "Responsable Marketing",
        contractType: "FIXED",
        fixedSalary: 750000,
        hireDate: new Date("2022-09-01"),
      },
      {
        firstName: "Ibrahima",
        lastName: "Fall",
        email: "ibrahima.fall@digitalmarketing.sn",
        employeeCode: "DM002",
        position: "Graphiste",
        contractType: "HONORARIUM",
        hourlyRate: 5000,
        hireDate: new Date("2023-02-15"),
      },
      {
        firstName: "Mariama",
        lastName: "Tour√©",
        email: "mariama.toure@digitalmarketing.sn",
        employeeCode: "DM003",
        position: "Community Manager",
        contractType: "FIXED",
        fixedSalary: 450000,
        hireDate: new Date("2023-04-10"),
      },
    ];

    for (const empData of digitalEmployeeData) {
      // G√©n√©rer le QR code bas√© sur le matricule
      const qrCodeData = await generateQRCodeDataURL(empData.employeeCode);

      const employee = await prisma.employee.create({
        data: {
          firstName: empData.firstName,
          lastName: empData.lastName,
          email: empData.email,
          employeeCode: empData.employeeCode,
          position: empData.position,
          contractType: empData.contractType,
          fixedSalary: empData.fixedSalary,
          hourlyRate: empData.hourlyRate,
          hireDate: empData.hireDate,
          isActive: true,
          companyId: companies[1].id,
          qrCode: qrCodeData,
        },
      });

      // Cr√©er un compte utilisateur pour cet employ√©
      const userAccount = await prisma.user.create({
        data: {
          firstName: empData.firstName,
          lastName: empData.lastName,
          email: empData.email,
          password: await bcrypt.hash("employe123", 10), // Mot de passe par d√©faut
          role: "USER",
          isActive: true,
          companyId: companies[1].id,
          employeeId: employee.id,
        },
      });

      digitalEmployees.push({ employee, user: userAccount });
      console.log(
        `‚úÖ Employ√© ${empData.firstName} ${empData.lastName} cr√©√© avec QR code et compte utilisateur`
      );
    }

    // Cr√©er des employ√©s suppl√©mentaires avec comptes utilisateurs
    console.log("üë§ Cr√©ation d'employ√©s suppl√©mentaires...");

    const additionalEmployeeData = [
      {
        firstName: "Moussa",
        lastName: "Sarr",
        email: "moussa.sarr@techsolutions.sn",
        employeeCode: "TS004",
        position: "Technicien",
        contractType: "HONORARIUM",
        hourlyRate: 3000,
        hireDate: new Date("2023-06-01"),
        companyId: companies[0].id,
      },
      {
        firstName: "A√Øda",
        lastName: "Gueye",
        email: "aida.gueye@digitalmarketing.sn",
        employeeCode: "DM004",
        position: "Assistante Marketing",
        contractType: "FIXED",
        fixedSalary: 350000,
        hireDate: new Date("2024-02-01"),
        companyId: companies[1].id,
      },
    ];

    const additionalEmployees = [];
    for (const empData of additionalEmployeeData) {
      // G√©n√©rer le QR code bas√© sur le matricule
      const qrCodeData = await generateQRCodeDataURL(empData.employeeCode);

      const employee = await prisma.employee.create({
        data: {
          firstName: empData.firstName,
          lastName: empData.lastName,
          email: empData.email,
          employeeCode: empData.employeeCode,
          position: empData.position,
          contractType: empData.contractType,
          fixedSalary: empData.fixedSalary,
          hourlyRate: empData.hourlyRate,
          hireDate: empData.hireDate,
          isActive: true,
          companyId: empData.companyId,
          qrCode: qrCodeData,
        },
      });

      // Cr√©er le compte utilisateur associ√©
      const userAccount = await prisma.user.create({
        data: {
          firstName: empData.firstName,
          lastName: empData.lastName,
          email: empData.email,
          password: await bcrypt.hash("employe123", 10),
          role: "USER",
          isActive: true,
          companyId: empData.companyId,
          employeeId: employee.id,
        },
      });

      additionalEmployees.push({ employee, user: userAccount });
      console.log(
        `‚úÖ Employ√© ${empData.firstName} ${empData.lastName} cr√©√© avec QR code et compte utilisateur`
      );
    }

    console.log(
      `‚úÖ ${additionalEmployees.length} employ√©s suppl√©mentaires cr√©√©s avec comptes utilisateurs`
    );

    console.log("üéâ Seeding termin√© avec succ√®s !");
    console.log("\nüìä R√©sum√© :");
    console.log(`- ${companies.length} entreprises`);
    console.log(`- 1 super admin (sans profil employ√©)`);
    console.log(
      `- ${adminEmployees.length} employ√©s admin avec comptes utilisateur`
    );
    console.log(
      `- ${cashierEmployees.length} employ√©s caissier avec comptes utilisateur`
    );
    console.log(
      `- ${
        techEmployees.length +
        digitalEmployees.length +
        additionalEmployees.length
      } employ√©s standards avec comptes utilisateur`
    );
    console.log(
      `- Total employ√©s: ${
        adminEmployees.length +
        cashierEmployees.length +
        techEmployees.length +
        digitalEmployees.length +
        additionalEmployees.length
      } (tous avec QR codes)`
    );

    console.log("\nüîë Comptes de test :");
    console.log("Super Admin: superadmin@gestion-salaires.com / superadmin123");
    console.log("Admin Tech: admin@techsolutions.com / admin123");
    console.log("Admin Digital: admin@digitalmarketing.sn / admin123");
    console.log("Caissier Tech: caissier@techsolutions.com / caissier123");
    console.log("Caissier Digital: caissier@digitalmarketing.sn / caissier123");
    console.log("Employ√©s: [email] / employe123");
  } catch (error) {
    console.error("‚ùå Erreur lors du seeding:", error);
    throw error;
  } finally {
    await prisma.$disconnect();
  }
}

main().catch((e) => {
  console.error(e);
  process.exit(1);
});
